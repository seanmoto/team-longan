<!DOCTYPE html>
<html>
<head>
  <title>Team Longan</title><!-- TODO create name -->
  <meta charset="UTF-8">
  <script xmlns="http://www.w3.org/1999/xhtml" async="" src="https://cdn.rawgit.com/eligrey/FileSaver.js/5ed507ef8aa53d8ecfea96d96bc7214cd2476fd2/FileSaver.min.js"></script>
</head>
<body>
  <div>
    Event Name: <input type="text" id="event-name" maxlength="150"><!-- TODO check max length-->
    Start Date: <input type="date" id="start-date">
	Start Time: <input type="time" id="start-time" value="00:00">
	End Time: <input type="time" id="end-time" value="00:00">
	Location: <input type="text" id="location" maxlength="150"><!-- TODO check max length-->
	<button onclick="createIcsFile()">Generate Event File</button>
  </div>
  
  <script>
    /** 
	 * createIcsFile, Creates a .ics file based on the user's input
	 * @param TODO
	 */
	function createIcsFile() { //TODO This function will be hooked into an html form
	  //needs EVENT_NAME, START_TIME, END_TIME, START_DATE, END_DATE, TIME_ZONE, LOCATION
	  let content = "BEGIN:VCALENDAR\r\nVERSION:2.0\r\nCALSCALE:GREGORIAN\r\n";
	  //TODO add tzid to content
	  content = content.concat(createVevent());
	  content = content.concat("END:VCALENDAR");
	  let blob = new Blob([content], {type: "text/plain;charset=utf-8"});
	  saveAs(blob, "output.ics");//TODO dynamic filename
	}
	
	/**
	 * createVevent, generates a .ics VEVENT
	 */
	function createVevent() {
	  let vuid, vclass, dtstamp, dtstart, dtend, location, summary;
	  let rtn = "BEGIN:VEVENT\r\n";
	  //TODO add uid
	  let dt = new Date();
	  rtn = rtn.concat("DTSTAMP:" + dt.getFullYear() + padZeros(dt.getMonth() + 1, 2) + padZeros(dt.getDate(), 2) + "T" +
	    dt.getHours() + dt.getMinutes() + "00" + "\r\n");
		
      //TODO validate start time is before end time
	  //TODO dtstart
	  //TODO dtend

	  rtn = rtn.concat("LOCATION:" + document.getElementById("location").value + "\r\n");
	  rtn = rtn.concat("SUMMARY:" + document.getElementById("event-name").value + "\r\n");
	  
	  //temp for testing
	  rtn = rtn.concat("UID:123412345fscvw@example.com\r\nDTSTART:20180713T100000\r\nDTEND:20180713T130000\r\n");
	  
	  
	  rtn = rtn.concat("END:VEVENT\r\n");
      return rtn;
	}
	
	/** TODO
	 * createTzid, Gets the user's timezone and converts it into a .ics TZID
	 */
	function createTzid() {
	}
	
	/**
	 * createDateTimeString, Converts html date and time inputs into a .ics date-time string
	 * @param date, date of the event, expected format: year-month-day e.g. 2000-01-31
	 * @param time, time of the event, expected format: hour:minute e.g. 13:59
	 * @return date-time string usable in .ics files
	 */
	function createDateTimeString(date, time) {
	  return date.replace(/-/g, "") + "T" + time.replace(":", "") + "00";
	}
	
	//TODO has to create a unique user id each time for each event (format: string@string)
    function createUid() {
	
	}
	
	window.onload = function() {
	  const dt = new Date();
	  const date = dt.getFullYear() + "-" + padZeros(dt.getMonth() + 1, 2) + "-" + padZeros(dt.getDate(), 2);
	  document.getElementById("start-date").value = date;
	}
	
	function padZeros(num, width) {
	  rtn = num.toString();
	  while(rtn.length < width) {
	    rtn = "0".concat(rtn);
	  }
	  return rtn;
	}
	
  </script>
</body>
</html>
